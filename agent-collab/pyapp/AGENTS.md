# **AGENTS.md（Python 后端开发规范版）**

### Python Backend Code Authoring Principles for AI Agents

> 本文件在通用后端架构理念（Clean Architecture / DDD / Fowler Patterns）基础上，补充 **Python 语言特性与工程实践** 的约束，用于指导 AI 在生成/修改 Python 后端代码时保持一致性、可维护性与可测试性。

---

# **🔒 操作边界（必须遵守）**

1. **文档可写，代码禁写（默认）**
   - 在未获得人类明确授权前：仅允许输出建议与示例（纯文本），不得写入/修改任何 `.py` 源码文件。
2. **获得明确授权后才可写代码**
   - 仅当人类提供明确指令（例如 `WRITE_CODE:`）后，AI 才能对 Python 源码进行写入或修改。
3. **若请求存在歧义，先确认**
   - 必须先问清楚“需要我直接改文件，还是只输出文本建议？”再继续。

---

# **📘 概述**

Python 的优势在于：

* 高表达力与丰富生态 → 便于快速交付与迭代
* 动态特性强 → 若无约束，容易产生“隐式耦合”与“运行时惊喜”
* 同时存在同步与异步模型（threading / asyncio）→ 需明确边界与一致策略

因此，本规范强调：**类型可读、异常可控、异步不阻塞、边界清晰**。

---

# **🎯 AI 编写 Python 后端代码的核心目标**

1. **可读性优先（Readable First）**
2. **类型与契约清晰（Typed & Explicit Contracts）**
3. **异常与资源管理可靠（Safe Exceptions & Resources）**
4. **同步/异步边界明确（Clear Sync/Async Boundaries）**
5. **易测试（Testable by Design）**

---

# **🧠 Python 语言特性相关的十大黄金法则**

## **📌 法则 1：对外边界必须显式类型与契约**

* API 输入输出使用明确 DTO/Schema（不要裸 `dict` 贯穿业务）
* 核心业务函数使用类型标注（至少对参数与返回值标注）
* 避免 `Any` 在核心路径蔓延；只允许在边界适配层出现并尽快收敛

---

## **📌 法则 2：异常必须分类处理，禁止吞异常**

* 业务可预期错误：定义稳定的异常类型/错误码（供上层映射为 HTTP/MQ 结果）
* 系统错误：记录上下文并向上抛出，避免静默失败
* 外部依赖错误：区分“可重试/不可重试”，避免无限重试与雪崩

---

## **📌 法则 3：资源必须通过上下文管理器正确释放**

* 文件、连接、锁等必须使用 `with` / context manager 管理生命周期
* 禁止在核心逻辑中依赖隐式全局连接或隐式 session

---

## **📌 法则 4：同步与异步不可混用为“隐式阻塞”**

* 在 `async` 代码里禁止直接调用阻塞 I/O（DB/HTTP/磁盘）而不做隔离
* 明确策略：全链路异步或在边界做隔离（线程池/进程池/同步适配层）
* 取消与超时必须贯穿（对外请求必须有 timeout）

---

## **📌 法则 5：避免魔法与元编程滥用**

* 业务逻辑避免装饰器层层包裹导致流程不可见
* 禁止运行时 monkey patch 作为常规方案
* 反射/动态导入只允许在插件边界或框架层，并需给出清晰文档

---

## **📌 法则 6：可变默认参数与共享状态必须禁止**

* 禁止使用可变对象作为默认参数（如 `[]` / `{}`）
* 核心逻辑避免依赖模块级全局可变状态（缓存、计数器、单例连接等）
* 需要共享状态时通过依赖注入与明确生命周期管理

---

## **📌 法则 7：日志必须结构化且可关联**

* 禁止用 `print` 作为服务端日志
* 日志字段应包含请求关联信息（trace/request id 等）
* 错误日志必须包含足够上下文，但不得泄露敏感信息

---

## **📌 法则 8：核心领域逻辑应保持纯净、可重放**

* 领域层尽量无 I/O 副作用；I/O 通过接口注入在外层完成
* 同一输入在无外部状态变化下应得到确定输出（便于测试与回放）

---

## **📌 法则 9：模块与包边界清晰，禁止跨层泄漏**

* Controller/Handler 只做参数解析、校验、调用 use case、结果映射
* Repository/Client 仅负责外部依赖访问，不承载业务规则
* DTO、领域模型、持久化模型分层清晰，避免互相污染

---

## **📌 法则 10：测试优先覆盖失败路径与边界条件**

* 单元测试优先覆盖：校验失败、外部依赖失败、超时/取消、幂等性
* 避免脆弱测试：减少对真实时间/随机/全局状态的依赖
* 需要可控时间与随机性时，通过注入方式实现可重放

---

# **🧩 推荐的 Python 后端目录结构（示例）**

> 仅作结构参考，实际以仓库既有约定为准。

```
/app
  /domain
  /use_cases
  /interfaces
  /infra
```

原则：

* 业务规则集中在 `domain/use_cases`
* `infra` 存放 DB/HTTP/MQ 等细节实现
* 最外层负责装配依赖，内层只依赖抽象（接口/Protocol）

---

# **✅ 输出要求（AI 生成 Python 代码时）**

* 默认输出：设计说明 + 关键接口/流程 + 示例代码（纯文本）
* 若被允许落盘修改代码：必须同时给出变更清单与验证口径（如何运行测试、如何回归）
